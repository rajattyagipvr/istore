buildPack: maven
pipelineConfig:
  agent:
    image: maven
    label: jenkins-maven
  env:
  - name: APP_NAME
    value: istore
  - name: BRANCH_NAME
    value: master
  - name: BUILD_NUMBER
    value: "2"
  - name: JOB_NAME
    value: rajattyagipvr/istore/master
  - name: PIPELINE_KIND
    value: release
  - name: PULL_REFS
    value: 'master:'
  - name: REPO_NAME
    value: istore
  - name: REPO_OWNER
    value: rajattyagipvr
  - name: SOURCE_URL
    value: https://github.com/rajattyagipvr/istore.git
  pipelines:
    overrides:
    - name: mvn-deploy
      pipeline: release
      stage: build
      step:
        agent:
          image: maven
        dir: /workspace/source
        name: build-mv-deploy-override
        sh: mvn -Pprod,swagger,no-liquibase clean deploy -DskipTests
      type: replace
    post: {}
    pullRequest:
      pipeline:
        env:
        - name: APP_NAME
          value: istore
        - name: BRANCH_NAME
          value: master
        - name: BUILD_NUMBER
          value: "2"
        - name: JOB_NAME
          value: rajattyagipvr/istore/master
        - name: PIPELINE_KIND
          value: release
        - name: PULL_REFS
          value: 'master:'
        - name: REPO_NAME
          value: istore
        - name: REPO_OWNER
          value: rajattyagipvr
        - name: SOURCE_URL
          value: https://github.com/rajattyagipvr/istore.git
        options:
          containerOptions:
            env:
            - name: APP_NAME
              value: istore
            - name: BRANCH_NAME
              value: master
            - name: BUILD_NUMBER
              value: "2"
            - name: DOCKER_REGISTRY
              valueFrom:
                configMapKeyRef:
                  key: docker.registry
                  name: jenkins-x-docker-registry
            - name: GIT_AUTHOR_EMAIL
              value: jenkins-x@googlegroups.com
            - name: GIT_AUTHOR_NAME
              value: jenkins-x-bot
            - name: GIT_COMMITTER_EMAIL
              value: jenkins-x@googlegroups.com
            - name: GIT_COMMITTER_NAME
              value: jenkins-x-bot
            - name: JOB_NAME
              value: rajattyagipvr/istore/master
            - name: MAVEN_OPTS
              value: -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
            - name: PIPELINE_KIND
              value: release
            - name: PULL_REFS
              value: 'master:'
            - name: REPO_NAME
              value: istore
            - name: REPO_OWNER
              value: rajattyagipvr
            - name: SOURCE_URL
              value: https://github.com/rajattyagipvr/istore.git
            - name: XDG_CONFIG_HOME
              value: /home/jenkins
            - name: _JAVA_OPTIONS
              value: -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap
                -Dsun.zip.disableMemoryMapping=true -XX:+UseParallelGC -XX:MinHeapFreeRatio=5
                -XX:MaxHeapFreeRatio=10 -XX:GCTimeRatio=4 -XX:AdaptiveSizePolicyWeight=90
                -Xms10m -Xmx192m
            name: ""
            resources:
              requests:
                cpu: 400m
                memory: 512Mi
            securityContext:
              privileged: true
            volumeMounts:
            - mountPath: /home/jenkins
              name: workspace-volume
            - mountPath: /kaniko/.docker
              name: jenkins-docker-cfg
            - mountPath: /root/.m2/
              name: volume-0
            - mountPath: /home/jenkins/.gnupg
              name: volume-1
          volumes:
          - emptyDir: {}
            name: workspace-volume
          - name: jenkins-docker-cfg
            secret:
              secretName: jenkins-docker-cfg
          - name: volume-0
            secret:
              secretName: jenkins-maven-settings
          - name: volume-1
            secret:
              secretName: jenkins-release-gpg
        stages:
        - agent:
            image: maven
          dir: /workspace/source
          name: from-build-pack
          steps:
          - command: mvn versions:set -DnewVersion=$PREVIEW_VERSION
            dir: /workspace/source
            image: maven
            name: build-set-version
          - command: mvn install
            dir: /workspace/source
            image: maven
            name: build-mvn-install
          - command: /kaniko/executor --cache=true --cache-dir=/workspace --context=/workspace/source
              --dockerfile=/workspace/source/Dockerfile --destination=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/$APP_NAME:$VERSION
              --cache-repo=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/cache
            dir: /workspace/source
            image: gcr.io/kaniko-project/executor
            name: build-container-build
          - command: make preview
            dir: /workspace/source/charts/preview
            image: 702769831180.dkr.ecr.ap-south-1.amazonaws.com/702769831180/jxl
            name: promote-make-preview
          - command: jx preview --app $APP_NAME --dir ../..
            dir: /workspace/source/charts/preview
            image: 702769831180.dkr.ecr.ap-south-1.amazonaws.com/702769831180/jxl
            name: promote-jx-preview
    release:
      pipeline:
        env:
        - name: APP_NAME
          value: istore
        - name: BRANCH_NAME
          value: master
        - name: BUILD_NUMBER
          value: "2"
        - name: JOB_NAME
          value: rajattyagipvr/istore/master
        - name: PIPELINE_KIND
          value: release
        - name: PULL_REFS
          value: 'master:'
        - name: REPO_NAME
          value: istore
        - name: REPO_OWNER
          value: rajattyagipvr
        - name: SOURCE_URL
          value: https://github.com/rajattyagipvr/istore.git
        options:
          containerOptions:
            env:
            - name: APP_NAME
              value: istore
            - name: BRANCH_NAME
              value: master
            - name: BUILD_NUMBER
              value: "2"
            - name: DOCKER_REGISTRY
              valueFrom:
                configMapKeyRef:
                  key: docker.registry
                  name: jenkins-x-docker-registry
            - name: GIT_AUTHOR_EMAIL
              value: jenkins-x@googlegroups.com
            - name: GIT_AUTHOR_NAME
              value: jenkins-x-bot
            - name: GIT_COMMITTER_EMAIL
              value: jenkins-x@googlegroups.com
            - name: GIT_COMMITTER_NAME
              value: jenkins-x-bot
            - name: JOB_NAME
              value: rajattyagipvr/istore/master
            - name: MAVEN_OPTS
              value: -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
            - name: PIPELINE_KIND
              value: release
            - name: PULL_REFS
              value: 'master:'
            - name: REPO_NAME
              value: istore
            - name: REPO_OWNER
              value: rajattyagipvr
            - name: SOURCE_URL
              value: https://github.com/rajattyagipvr/istore.git
            - name: XDG_CONFIG_HOME
              value: /home/jenkins
            - name: _JAVA_OPTIONS
              value: -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap
                -Dsun.zip.disableMemoryMapping=true -XX:+UseParallelGC -XX:MinHeapFreeRatio=5
                -XX:MaxHeapFreeRatio=10 -XX:GCTimeRatio=4 -XX:AdaptiveSizePolicyWeight=90
                -Xms10m -Xmx192m
            name: ""
            resources:
              requests:
                cpu: 400m
                memory: 512Mi
            securityContext:
              privileged: true
            volumeMounts:
            - mountPath: /home/jenkins
              name: workspace-volume
            - mountPath: /kaniko/.docker
              name: jenkins-docker-cfg
            - mountPath: /root/.m2/
              name: volume-0
            - mountPath: /home/jenkins/.gnupg
              name: volume-1
          volumes:
          - emptyDir: {}
            name: workspace-volume
          - name: jenkins-docker-cfg
            secret:
              secretName: jenkins-docker-cfg
          - name: volume-0
            secret:
              secretName: jenkins-maven-settings
          - name: volume-1
            secret:
              secretName: jenkins-release-gpg
        stages:
        - agent:
            image: maven
          dir: /workspace/source
          name: from-build-pack
          steps:
          - command: jx step git credentials
            dir: /workspace/source
            image: gcr.io/jenkinsxio-labs-private/jxl
            name: setup-jx-git-credentials
          - command: mvn -Pprod,swagger,no-liquibase clean deploy -DskipTests
            dir: /workspace/source
            image: maven
            name: build-build-mv-deploy-override
          - command: /kaniko/executor --cache=true --cache-dir=/workspace --context=/workspace/source
              --dockerfile=/workspace/source/Dockerfile --destination=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/$APP_NAME:$VERSION
              --cache-repo=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/cache
            dir: /workspace/source
            image: gcr.io/kaniko-project/executor
            name: build-container-build
          - command: jx step changelog --version v${VERSION}
            dir: /workspace/source/charts/istore
            image: 702769831180.dkr.ecr.ap-south-1.amazonaws.com/702769831180/jxl
            name: promote-changelog
          - command: jx step helm release
            dir: /workspace/source/charts/istore
            image: 702769831180.dkr.ecr.ap-south-1.amazonaws.com/702769831180/jxl
            name: promote-helm-release
          - command: jx promote -b --all-auto --timeout 1h --version ${VERSION}
            dir: /workspace/source/charts/istore
            image: 702769831180.dkr.ecr.ap-south-1.amazonaws.com/702769831180/jxl
            name: promote-jx-promote
      setVersion:
        steps:
        - image: maven
          steps:
          - comment: so we can retrieve the version in later steps
            name: next-version
            sh: jx step next-version --filename pom.xml
          - name: tag-version
            sh: jx step tag --version \$(cat VERSION)
